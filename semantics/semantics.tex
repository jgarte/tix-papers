The reduction rules are presented in figure~\pref{fig:semantics:nix-light} and
the evaluation contexts in
figure~\pref{fig:semantics:nix-light:reduction-contexts}.

The rules for the pattern-matching are in
figure~\pref{fig:semantics:nix-light:patterns}

\begin{figure}
  \begin{tabular}{rl}
    \dstepa{\{ \s/ = \e/; $\ldots{}$\}.\s/}{$e$}{}
    \dstepa{\{ \s/ = \e/; $\ldots{}$\}.\s/ or $e'$}{$e$}{}
    \dstepa{$v.s \text{ or } e'$}{$e'$}{if $\v/ \neq$ \{ \s/ = \e/; $\ldots{}$ \}}
    \dstepa{$(x:e_1) e_2$}{$\substp{x}{e_2}{e_1}$}{}
    \dstepa{$(p:e_1) v$} {$\substp{p}{v}{e_1}$}{if $p \neq x$}
    \dstepa{with \{ $l_1$ = $e_1$; $\cdots{}$; $l_n$ = $e_n$; \} ; \e/}{
      \e/[\assign{l_1}{\eone}; ...; \assign{l_n}{\en}]
    }{}
    \dstepa{raise \e/}{$\bot$}{}
    \dstepa{($v \in \τ$ ? \eone : $e_2$)}{\eone}{if $\vdash v : \τ$}
    \dstepa{($v \in \τ$ ? \eone : $e_2$)}{$e_2$}{if $\vdash v : \lnot\τ$}
    \dstepa{let $x$ = $e$; in $e'$}{%
      \subst{x}{\text{let $x$ = $e$; in $x$}}{$e'$}
    }{}
    \dstepa{let \xone = \eone; ...; \xn = \en; in e}{%
      \parbox[t]{10cm}{%
        (let $r$ = \{ $x'_1$ = \eone; \} $\orthplus \cdots \orthplus$ \{ $x'_n$ = \en \}; in e)
      [ \\ \assign{\xone}{r.x'_1}; \ldots{}; \assign{\xn}{r.x'_n} \\ ]
      }
    }{}
  \end{tabular}
  \caption{Nix-light reduction rules\label{fig:semantics:nix-light}}
\end{figure}

\begin{figure}
% TODO Rewrite in a clear way. Exlpain the fact that we can reordonate stuff because we got a
% commutative monoid.

  \begin{tabular}{rl}
    \eqdefa{\assignp{q@x}{e}}{\assign{x}{e}; \assignp{q}{e}}{}
    \eqdefa{\assignp{(\{ x \} \orthplus q)}{(\{ x = e; \} \orthplus v)}}{\assignp{x}{e}; \assignp{q}{v}}{}
    \eqdefa{\assignp{(\{ x ? e' \} \orthplus q)}{(\{ x = e; \} \orthplus v)}}{\assignp{x}{e}; \assignp{q}{v}}{}
    \eqdefa{\assignp{(\{ x ? e \} \orthplus q)}{(v_1 \orthplus v_2)}}{\assignp{x}{e}; \assignp{q}{\left( v_1 \orthplus v_2\right)}}{if $v_1 \neq \{ x = e'; \}$}
    \eqdefa{\assignp{\{\}}{\{ \}}}{ø}{}
    \eqdefa{\assignp{\{ .. \}}{v}}{ø}{}
    \eqdefa{\assignp{Cons(x, x')}{Cons(e, e')}}{\assign{x}{e}; \assign{x'}{e'}}{}
  \end{tabular}
  \caption{Semantic of the pattern-matching in nix-light\label{fig:semantics:nix-light:patterns}}
\end{figure}

\begin{figure}
  \begin{grammar}
    \bfseries
    <E> ::= [] \| \meta{E e}
    \alt \meta{E.a} \| \meta{E.a} or \meta{e} \| \meta{v.F} \| \meta{v.F} or \meta{e}
    \alt \{ \v/ = \e/; \ldots{}; \v/ = \e/; \E/ = \e/; \ldots{}; \e/ = \e/ \}
    \alt with \E/; \e/ | if \E/ then \e/ else \e/

    <F> ::= \E/.\a/ \| \v/.\meta{F}
  \end{grammar}
  \caption{Reduction contexts for nix-light\label{fig:semantics:nix-light:reduction-contexts}}
\end{figure}
