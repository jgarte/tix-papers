\documentclass{article}

\usepackage{fontspec}
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage{ amssymb }

\usepackage{mathtools}
\usepackage{xfrac}

\usepackage{syntax}
\renewcommand{\grammarlabel}[2]{\meta{#1 #2}}
\newcommand{\meta}[1]{{\it{#1}}} % For meta syntax
\renewcommand{\|}{\textrm{|}}
\def\e/{\meta{e}}
\def\E/{\meta{E}}
\def\a/{\meta{a}}
\def\b/{\meta{b}}
\def\c/{\meta{c}}
\def\p/{\meta{p}}
\def\q/{\meta{q}}
\def\f/{\meta{f}}
\def\x/{\meta{x}}
\def\o/{\meta{o}}
\def\v/{\meta{v}}

\title{Nix simplified semantics}
\author{Théophane Hufschmitt}
\date{}

\newcommand{\assign}[2]{\ensuremath{\sfrac{#2}{#1}}}
% \newcommand{\assign}[2]{\ensuremath{#2{#1}}}
\newcommand{\assignp} [2] {\assign{#1}{#2}}
\newcommand{\subst} [3] {#3 [\assign{#1}{#2}]}
\newcommand{\substp} [3] {#3 [\assignp{#1}{#2}]}
\newcommand{\dstep} [2] {#1 \ensuremath{\rightarrow} #2}
\newcommand{\ndstep} [2] {#1 \ensuremath{\nrightarrow} #2}
\newcommand{\ndsteps} [2] {#1 \ensuremath{\nrightarrow^*} #2}
\newcommand{\dstepa} [3] {\dstep{#1}{&#2}~\emph{#3} \\}

\newcommand{\eqdef}[2]{#1 \ensuremath{\overset{\text{def}}{=}} #2}
\newcommand{\eqdefa}[3]{\eqdef{#1}{&#2} \emph{#3} \\}

\newcommand{\xone}{\ensuremath{x_1}}
\newcommand{\xn}{\ensuremath{x_n}}
\newcommand{\eone}{\ensuremath{e_1}}
\newcommand{\etwo}{\ensuremath{e_2}}
\newcommand{\en}{\ensuremath{e_n}}

\begin{document}

\maketitle{}

\par{Reduction rules}

\begin{tabular}{rl}
  \dstepa{\{ x = e; ... \}.x}{e}{}
  \dstepa{\{ x = e; ... \}.x or e}{e}{}
  \dstepa{e.a or e'}{e'}{if \ndsteps{e}{\{ x = e; ... \}}}
  % TODO: complete
  \dstepa{(x:e1) e2}{\substp{x}{e2}{e1}}{}
  \dstepa{(p:e1) v} {\substp{p}{v} {e1}}{}
  \dstepa{with \{ \xone = \eone; ...; \xn= \en; e \}}{%
    e[\assign{\xone}{\eone}; ...; \assign{\xn}{\en}]
  }{}
  \dstepa{raise e}{$\bot$}{}
  \dstepa{if true then \eone else \etwo}{\eone}{}
  \dstepa{if false then \eone else \etwo}{\etwo}{}
  \dstepa{let $x$ = $e$; in $e'$}{%
    \subst{x}{\text{let $x$ = $e$; in $x$}}{$e'$}
  }{}
  \dstepa{let \xone = \eone; ...; \xn = \en; in e}{%
    \parbox[t]{10cm}{%
      (let $r$ = \{ $x'_1$ = \eone; ...; $x'_n$ = \en \}; in e)
      [ \\ \assign{\xone}{r.x'_1}; \ldots{}; \assign{\xn}{r.x'_n} \\ ]
      }
  }{}
\end{tabular}

Where

\begin{tabular}{rl}
  \eqdefa{\assignp{q@x}{e}}{\assign{x}{e}; \assignp{q}{e}}{}
  \eqdefa{\assignp{\{ x, f_1, \ldots{}, f_n \}}{\{ x = e; g_1; \ldots{}; g_n; \}}}{%
    \assign{x}{e}; \assignp{f_1, \ldots{}, f_n}{g_1; \ldots{}; g_n;}}{}
  \eqdefa{\assignp{\{ x ? e', f_1, \ldots{}, f_n \}}{\{ x = e; g_1; \ldots{}; g_n; \}}}{%
    \assign{x}{e}; \assignp{\{f_1, \ldots{}, f_n\}}{\{g_1; \ldots{}; g_n;\}}}{}
  \eqdefa{\assignp{\{ x ? e', f_1, \ldots{}, f_n \}}{\{ g_1; \ldots{}; g_n; \}}}{%
    \assign{x}{e'}; \assignp{\{f_1, \ldots{}, f_n\}}{\{g_1; \ldots{}; g_n;\}}}{if \ndsteps{\{g_1; \ldots{}; g_n;\}}{\{ x = e; ...\}}}
  \eqdefa{\assignp{\{ ... \}}{\{g_1; \ldots{}; g_n;\}}}{ø}{}
  \eqdefa{\assignp{Cons(x, x')}{Cons(e, e')}}{\assign{x}{e}; \assign{x'}{e'}}{}
\end{tabular}

\par{Reduction contexts}

\begin{grammar}
  \bfseries
  <E> ::= [] \| \meta{E e}
  \alt \meta{E.w} \| \meta{E.w} or \meta{e} \| \meta{v.F} \| \meta{v.F} or \meta{e}
  \alt \{ \x/ = \e/; \ldots{}; \x/ = \e/; \E/ = \e/; \ldots{}; \e/ = \e/ \}
  \alt with \E/; \e/ | if \E/ then \e/ else \e/

  <F> ::= \E/.\a/ \| \v/.\meta{F}
\end{grammar}

\end{document}

