\subsection{The $\λ\&-calculus$}

\subsubsection{Patterns}

The typing of patterns is inspired by~\cite{Fri04}: To every pattern $p$, we
associate a type $\Lbag p \Rbag$. The exact definition of $\Lbag \_ \Rbag$ is
given in figure~\pref{typing::pattern-accept}.

The intuition behind this operator is that $\matchType{p}$ represents the type
of the values that will be accepted by the pattern. So for example,
$\matchType{x}$ is equal to $\any$ as the pattern $x$ matches any value.
Likewise, $\matchType{\{ x, y ? 1 \}}$ is $\{ x = \any; y = \any \vee \undef
\}$.

We also define the matching $\ofTypeP{p}{\τ}$ of a type $\τ$ against a pattern
$p$ (in figure~\pref{typing::pattern-ty-match}).
This represents the typing constraints that we can deduce from the applications
of a type $\τ$ to the pattern $p$. It is used to convert type annotations into
concrete typing environments. So for example, $\ofTypeP{\{ x, y \}}{\{ x = \τ;
y = \σ \}}$ is equal to the typing constraints $x : \τ$ and $y : \σ$, which may
be used to type the body of the corresponding function.

The typing rules are given by the
figures~\pref{typing::lambda-calculus},~\pref{typing::records}
and~\pref{typing::operators}.

\begin{figure}
  \begin{center}
    \begin{tabular}{rl}
      \eqdefa{$\matchType{x}$}{$\any$}{}
      \eqdefa{$\matchType{q@x}$}{$\matchType{q}$}{}
      \eqdefa{$\matchType{\{ f_1, \cdots, f_n \}}$}%
        {$\{ \matchType{f_1}; \cdots \matchType{f_n}; \}$}{}
      \eqdefa{$\matchType{l}$}{$l = \any$}{}
      \eqdefa{$\matchType{l ? e}$}{$l = \any \vee \undef$}{}
      \eqdefa{$\matchType{\text{Cons}(x_1, x_2)}$}{$\text{Cons}(\any, \any)$}{}
    \end{tabular}
  \end{center}
  \caption{Semantics of the $\matchType{\_}$ operator%
  \label{typing::pattern-accept}}
\end{figure}
\begin{figure}
  \begin{tabular}{rl}
    \eqdefa{$\ofTypeP{x}{\τ}$}{$\sfrac{x}{\τ}$}{}
    \eqdefa{$\ofTypeP{q@x}{\τ}$}{$\sfrac{x}{\τ}; \ofTypeP{q}{x}$}{}
    \eqdefa{$\ofTypeP{\{\}}{\{ x_1 ? c_1, \cdots, x_n ? c_n \}}$}{%
      $\sfrac{x_1}{\mathcal{B}(c_1)}; \cdots; \sfrac{x_n}{\mathcal{B}(c_n)}$}{}
    \eqdefa{%
      $\ofTypeP{%
        \{ s_1 = \τ_1; \cdots; s_m = \τ_m; \}%
      }{%
        \{x_1 ? c_1, \cdots, x_n ? c_n, \textbf{\ldots}\}%
      }$%
    }{%
      $\sfrac{x_1}{\mathcal{B}(c_1)}; \cdots; \sfrac{x_n}{\mathcal{B}(c_n)}$%
    }{%
      if %
      $\forall (i,j) \in \discrete{1}{m} \times \discrete{1}{n}, s_i \neq s_j$%
    }
    \eqdefa{$\ofTypeP{\{ s = \τ;\}}{\{ x \}}$}{$\sfrac{x}{\τ}$}{if $s = x$}
    \eqdefa{$\ofTypeP{\{ s = \τ;\}}{\{ x ? c \}}$}{$\sfrac{x}{\τ}$}{if $s = x$}
    \eqdefa{$%
      \ofTypeP{\{ s_1 = \τ_1; \cdots; s_n = \τ_n \}}{\{ x, f_1, \cdots, f_m \}}%
    $}{$%
      \sfrac{x}{\τ};%
      \ofTypeP{\{ s_2 = \τ_2; \cdots; s_n = \τ_n \}}{\{ f_1, \cdots, f_m \}}%
    $}{if $s_1 = x$}
    \eqdefa{
      $\ofTypeP{%
        \{ s_1 = \τ_1; \cdots; s_n = \τ_n \}}%
        {\{ x ? c, f_1 \cdots, f_m \}}$%
      }{%
        $\sfrac{x}{\τ};%
        \ofTypeP{\{ s_2 = \τ_2; \cdots; s_n = \τ_n \}}%
          {\{ f_1, \cdots, f_m \}}$%
      }{if $s_1 = x$}
    \eqdefa{%
      $\ofTypeP{\text{Cons}(\τ_1, \τ_2)}{\text{Cons}(x_1, x_2)}$%
    }{$\sfrac{x_1}{\τ_1}; \sfrac{x_2}{\τ_2}$}{}
  \end{tabular}
  \caption{Semantics of $\ofTypeP{p}{\τ}$%
  \label{typing::pattern-ty-match}}
\end{figure}
\begin{figure}
  \input{typing/lambdaCalculus}
  \caption{Typing rules for the $\λ\&-calculus$\label{typing::lambda-calculus}}
\end{figure}
\begin{figure}
    \input{typing/recordTypingRules}
  \caption{Typing rules for records\label{typing::records}}
\end{figure}

\begin{figure}
  \todo{add rules for operators}
  \caption{Typing rules for builtins operators\label{typing::operators}}
\end{figure}
